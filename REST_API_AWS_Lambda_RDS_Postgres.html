
<!DOCTYPE HTML>
<html lang="en-za" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>REST API AWS Lambda RDS Postgres Â· Site Title</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Author Name">
        
        

    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-mermaid-v8/mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-terminal/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-prism/prism-a11y-dark.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-insert-logo/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-intopic-toc/style.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
        <link rel="stylesheet" href="styles/website.css">
        
    



        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Plugins_Showcase.html" />
    
    
    <link rel="prev" href="./" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    NoNa Playground Showcase
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2" data-path="REST_API_AWS_Lambda_RDS_Postgres.html">
            
                <a href="REST_API_AWS_Lambda_RDS_Postgres.html">
            
                    
                    REST API AWS Lambda RDS Postgres
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="Plugins_Showcase.html">
            
                <a href="Plugins_Showcase.html">
            
                    
                    Plugins Showcase
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >REST API AWS Lambda RDS Postgres</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="crud-rest-api-with-lambda-rds-postgres-vpc-and-logging">CRUD REST API with Lambda, RDS (Postgres), VPC and logging</h1>
<blockquote>
<p>This demonstrates a full CRUD REST API implementation with Postgres/RDS, VPC and logging</p>
</blockquote>
<pre class="language-"><code>**[terminal]
**[prompt foo@joe]**[path ~]**[delimiter  $ ]**[command ./myscript]
Normal output line. Nothing special here...
But...
You can add some colors. What about a warning message?
**[warning [WARNING] The color depends on the theme. Could look normal too]
What about an error message?
**[error [ERROR] This is not the error you are looking for]
</code></pre><div class="mermaid">
graph TD;
  A--&gt;B;
  A--&gt;C;
  B--&gt;D;
  C--&gt;D;
</div>


<p>including:</p>
<h5 id="rest-api">REST API</h5>
<ul>
<li>CRUD (feature module specific)</li>
<li>PG Promise</li>
<li>DB Migrations</li>
<li>Transactional Internal Integration testing with Docker</li>
<li>Factories/Fixtures</li>
</ul>
<h5 id="local-api--db-delivery">local API / DB delivery</h5>
<ul>
<li>Docker</li>
<li>Express</li>
<li>Postgres</li>
</ul>
<h5 id="aws-api-delivery">AWS API delivery</h5>
<p>using AWS CDK, including:</p>
<ul>
<li>VPC</li>
<li>RDS</li>
<li>Lambda (Custom asset bundling with Webpack, and external SQL files)</li>
</ul>
<h5 id="aws-config-management">AWS Config Management</h5>
<p>using AWS CDK, including support for:</p>
<ul>
<li>Paramstore</li>
<li>Secrets Manager</li>
<li>Local Static Config</li>
</ul>
<h5 id="logging">Logging</h5>
<p>Using a custom Winston Logger, including:</p>
<ul>
<li>AWS Cloudwatch Transport</li>
<li>Console Transport (for local logging)</li>
</ul>
<h3 id="related">Related</h3>
<ul>
<li><a href="int__api__rest--aws__cdk__api_gateway__lambda__code_asset__webpack--aws__cdk__config--aws__cdk__cognito__custom__passwordless_email__admin">REST API / AWS CDK (Lambda / Config / Cognito Passwordless Email Auth with Admin only user creation)</a></li>
</ul>
<h3 id="composition">Composition</h3>
<p>This integration branch is composed of the following isolation branches:</p>
<ul>
<li><a href="api__rest__crud__postgresql__pg_promise">REST API (CRUD) / PostgreSQL (PG Promise)</a></li>
<li><a href="iso__aws__cdk__api_gateway__lambda__code_asset__webpack">AWS CDK (API Gateway + Lambdas + webpack code bundling)</a></li>
<li><a href="iso__aws__cdk__config">AWS CDK (Config)</a></li>
<li><a href="iso__aws__cdk__vpc">AWS CDK (VPC)</a></li>
<li><a href="iso__aws__cdk__rds">AWS CDK (RDS)</a></li>
<li><a href="iso__logging__winston__cloudwatch">Logging Winston (Cloudwatch)</a></li>
</ul>
<h2 id="design">Design</h2>
<h3 id="books-api-aws-cdk-package"><code>books-api-aws-cdk</code> package</h3>
<h5 id="summary">summary</h5>
<ul>
<li>creates VPC, RDS and Lambda REST API stacks
using their respective packages
and through a common <code>BooksAPI</code> Construct</li>
</ul>
<h5 id="details">details</h5>
<ul>
<li>imports VPC, RDS and Lambda REST API stacks from their respective packages</li>
<li>creates the Books API App and Lambda REST API stack (but does not yet create the actual lambdas)</li>
<li>creates the VPC stack</li>
<li>creates the RDS stack (providing it with required VPC settings/data)</li>
<li>then creates the Lambdas on Books API App (providing it with required VPC settings/data)</li>
</ul>
<h2 id="code">Code</h2>
<h3 id="books-api-package"><code>books-api</code> package</h3>
<blockquote>
<p>Contains all the API code (DB interaction, request/response handlers, business logic etc) for the Books API,
but is platform agnostic, so knows nothing about AWS or express or wherever it&apos;s going to be &quot;served&quot;.</p>
</blockquote>
<pre class="language-"><code class="lang-text">+-- data
    +-- migrations
+-- src
    +-- common
        +-- data
        +-- http-response
        +-- logging
        +-- postgres
    +-- modules
        +-- books
            +-- business
            +-- data
            +-- persistence
            +-- presentation
</code></pre>
<h3 id="books-api-aws-cdk-package"><code>books-api-aws-cdk</code> package</h3>
<blockquote>
<p>Deploys the Books API package (including VPC, RDS &amp; Lambda REST API stacks) to AWS using AWS CDK</p>
</blockquote>
<pre class="language-"><code class="lang-text">+-- src
    +-- cloudformation
    +-- config
        +-- aws-params.json
        +-- aws-secrets.json
        +-- static.json
    +-- modules
        +-- books-api
            +-- books-api.construct.ts
            +-- books-api.construct.test.ts
    +-- index.ts
</code></pre>
<p><a href="https://raw.githubusercontent.com/Nona-Creative/nona-playground/int__api__rest__crud__postgresql__pg_promise--aws__cdk__config--aws__cdk__api_gateway__lambda__code_asset__webpack--aws__cdk__rds--aws__cdk__vpc--logging__winston__cloudwatch/packages/books-api-aws-cdk/src/index.ts" target="_blank">src/index.ts</a></p>
<pre class="language-"><code class="lang-typescript{.data-line=&quot;2,4-5,10&quot;}">import &apos;source-map-support/register&apos;
import { App } from &apos;@aws-cdk/core&apos;

import { BooksApi } from &apos;./modules/books-api&apos;

const stage = process.env.STAGE || &apos;dev&apos;
const appId = `${process.env.APP_NAME}-${process.env.PACKAGE_NAME}`

// App

const app = new App()

// Lambda REST API, VPC &amp; RDS stacks

const booksApi = new BooksApi(app, appId, { stage })
booksApi.createLambdaRestApi()
booksApi.loadConfig()
booksApi.createVPCStack()
booksApi.createRDSStack()

const codeZipPath = `assets/${appId}-handlers.zip`
const codeFilename = `${appId}-handlers`
booksApi.createLambdas(codeZipPath, codeFilename)

app.synth()
</code></pre>
<p><a href="https://raw.githubusercontent.com/Nona-Creative/nona-playground/int__api__rest__crud__postgresql__pg_promise--aws__cdk__config--aws__cdk__api_gateway__lambda__code_asset__webpack--aws__cdk__rds--aws__cdk__vpc--logging__winston__cloudwatch/packages/books-api-aws-cdk/src/config/aws-params.json" target="_blank">src/config/aws-params.json</a></p>
<pre class="language-"><code class="lang-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;STAGE&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stage&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;LOG_LEVEL&quot;</span><span class="token operator">:</span> <span class="token string">&quot;logLevel&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;PG_DATABASE&quot;</span><span class="token operator">:</span> <span class="token string">&quot;postgres/db&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;PG_HOST&quot;</span><span class="token operator">:</span> <span class="token string">&quot;postgres/host&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;PG_PORT&quot;</span><span class="token operator">:</span> <span class="token string">&quot;postgres/port&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;PG_USER&quot;</span><span class="token operator">:</span> <span class="token string">&quot;postgres/user&quot;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><a href="https://raw.githubusercontent.com/Nona-Creative/nona-playground/int__api__rest__crud__postgresql__pg_promise--aws__cdk__config--aws__cdk__api_gateway__lambda__code_asset__webpack--aws__cdk__rds--aws__cdk__vpc--logging__winston__cloudwatch/packages/books-api-aws-cdk/src/config/aws-params.json" target="_blank">src/config/aws-secrets.json</a></p>
<pre class="language-"><code class="lang-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;PG_PASSWORD&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dbMasterPassword&quot;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><a href="https://raw.githubusercontent.com/Nona-Creative/nona-playground/int__api__rest__crud__postgresql__pg_promise--aws__cdk__config--aws__cdk__api_gateway__lambda__code_asset__webpack--aws__cdk__rds--aws__cdk__vpc--logging__winston__cloudwatch/packages/books-api-aws-cdk/src/config/static.json" target="_blank">src/config/static.json</a></p>
<pre class="language-"><code class="lang-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;APP_ROOT_PATH&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/var/task&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ENVIRONMENT&quot;</span><span class="token operator">:</span> <span class="token string">&quot;aws&quot;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><a href="https://raw.githubusercontent.com/Nona-Creative/nona-playground/int__api__rest__crud__postgresql__pg_promise--aws__cdk__config--aws__cdk__api_gateway__lambda__code_asset__webpack--aws__cdk__rds--aws__cdk__vpc--logging__winston__cloudwatch/packages/books-api-aws-cdk/src/modules/books-api/books-api.construct.test.ts" target="_blank">src/modules/books-api/books-api.construct.test.ts</a></p>
<p><a href="https://raw.githubusercontent.com/Nona-Creative/nona-playground/int__api__rest__crud__postgresql__pg_promise--aws__cdk__config--aws__cdk__api_gateway__lambda__code_asset__webpack--aws__cdk__rds--aws__cdk__vpc--logging__winston__cloudwatch/packages/books-api-aws-cdk/src/modules/books-api/books-api.construct.ts" target="_blank">src/modules/books-api/books-api.construct.ts</a></p>
<p><code>BooksApi.createVPCStack</code></p>
<pre class="language-"><code class="lang-typescript"><span class="token function">createVPCStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>vpcStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VPCStack</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>scope<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-vpc-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>stage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> stage<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stage <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>vpcStack<span class="token punctuation">.</span><span class="token function">createSecurityGroup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token constant">LAMBDA_VPC_SECURITY_GROUP_NAME</span><span class="token punctuation">,</span>
    description<span class="token operator">:</span> <span class="token string">&apos;Lambda Security Group for app VPC&apos;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>vpcStack<span class="token punctuation">.</span><span class="token function">createSecurityGroup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token constant">RDS_VPC_SECURITY_GROUP_NAME</span><span class="token punctuation">,</span>
    description<span class="token operator">:</span> <span class="token string">&apos;RDS Security Group for app VPC&apos;</span><span class="token punctuation">,</span>
    allowAllOutbound<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>vpcStack<span class="token punctuation">.</span><span class="token function">addSecurityGroupIngressRule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    targetSecurityGroupName<span class="token operator">:</span> <span class="token constant">RDS_VPC_SECURITY_GROUP_NAME</span><span class="token punctuation">,</span>
    sourceSecurityGroupName<span class="token operator">:</span> <span class="token constant">LAMBDA_VPC_SECURITY_GROUP_NAME</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token constant">RDS_PORT</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>BooksApi.createRDSStack</code></p>
<pre class="language-"><code class="lang-typescript">  <span class="token function">createRDSStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vpcStack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR_MESSAGE_MISSING_AWS_CDK_STACK_VPC</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pathSatisfies</span><span class="token punctuation">(</span>isNil<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&apos;vpcStack&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;securityGroups&apos;</span><span class="token punctuation">,</span> <span class="token constant">RDS_VPC_SECURITY_GROUP_NAME</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR_MESSAGE_MISSING_AWS_VPC_SECURITY_GROUP_RDS</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> rdsSecurityGroup <span class="token operator">=</span> <span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&apos;vpcStack&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;securityGroups&apos;</span><span class="token punctuation">,</span> <span class="token constant">RDS_VPC_SECURITY_GROUP_NAME</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token keyword">as</span> SecurityGroup
    <span class="token keyword">this</span><span class="token punctuation">.</span>rdsStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RDSStack</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>scope<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-rds-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>stage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      stage<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stage<span class="token punctuation">,</span>
      vpc<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vpcStack<span class="token punctuation">.</span>vpc<span class="token punctuation">,</span>
      securityGroup<span class="token operator">:</span> rdsSecurityGroup<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">PG_USER</span><span class="token punctuation">,</span> <span class="token constant">PG_DATABASE</span><span class="token punctuation">,</span> <span class="token constant">PG_PASSWORD</span><span class="token punctuation">,</span> <span class="token constant">PG_PORT</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configData
    <span class="token keyword">this</span><span class="token punctuation">.</span>rdsStack<span class="token punctuation">.</span><span class="token function">createDatabase</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token operator">:</span> <span class="token constant">PG_USER</span><span class="token punctuation">,</span> databaseName<span class="token operator">:</span> <span class="token constant">PG_DATABASE</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token constant">PG_PASSWORD</span><span class="token punctuation">,</span> port<span class="token operator">:</span> <span class="token constant">PG_PORT</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
<p><code>BooksApi.createLambdaRestApi</code></p>
<pre class="language-"><code class="lang-typescript"><span class="token function">createLambdaRestApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiGatewayStack</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>scope<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-lambda-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>stage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    stage<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stage<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>BooksApi.loadConfig</code></p>
<pre class="language-"><code class="lang-typescript">  <span class="token function">loadConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR_MESSAGE_MISSING_AWS_CDK_STACK_REST_API</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// load AWS config</span>
    <span class="token keyword">const</span> awsConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWSConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-config-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>stage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      stage<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stage<span class="token punctuation">,</span>
      appName<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">APP_NAME</span> <span class="token operator">||</span> <span class="token string">&apos;&apos;</span><span class="token punctuation">,</span>
      packageName<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PACKAGE_NAME</span> <span class="token operator">||</span> <span class="token string">&apos;&apos;</span><span class="token punctuation">,</span>
      paramStoreKeys<span class="token operator">:</span> <span class="token constant">PARAM_STORE_KEYS</span><span class="token punctuation">,</span>
      secretsManagerKeys<span class="token operator">:</span> <span class="token constant">SECRETS_MANAGER_KEYS</span><span class="token punctuation">,</span>
      secretsArn<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SECRETS_ARN</span> <span class="token operator">||</span> <span class="token string">&apos;&apos;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> configData <span class="token operator">=</span> awsConfig<span class="token punctuation">.</span><span class="token function">loadConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// derive additional config</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">PG_USER</span><span class="token punctuation">,</span> <span class="token constant">PG_PASSWORD</span><span class="token punctuation">,</span> <span class="token constant">PG_DATABASE</span><span class="token punctuation">,</span> <span class="token constant">PG_PORT</span><span class="token punctuation">,</span> <span class="token constant">PG_HOST</span> <span class="token punctuation">}</span> <span class="token operator">=</span> configData
    <span class="token keyword">const</span> <span class="token constant">DATABASE_URL</span> <span class="token operator">=</span> <span class="token function">buildDatabaseConnectionURL</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      user<span class="token operator">:</span> <span class="token constant">PG_USER</span><span class="token punctuation">,</span>
      databaseName<span class="token operator">:</span> <span class="token constant">PG_DATABASE</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token constant">PG_PASSWORD</span><span class="token punctuation">,</span>
      port<span class="token operator">:</span> <span class="token constant">PG_PORT</span><span class="token punctuation">,</span>
      host<span class="token operator">:</span> <span class="token constant">PG_HOST</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> derivedConfig <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token constant">DATABASE_URL</span> <span class="token punctuation">}</span>

    <span class="token comment">// merged configs</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>configData <span class="token operator">=</span> <span class="token function">mergeRight</span><span class="token punctuation">(</span><span class="token function">mergeRight</span><span class="token punctuation">(</span>configData<span class="token punctuation">,</span> derivedConfig<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">STATIC_CONFIG</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
<p><code>BooksApi.createLambdas</code></p>
<pre class="language-"><code class="lang-typescript">  <span class="token function">createLambdas</span><span class="token punctuation">(</span>codeZipPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> codeFilename<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR_MESSAGE_MISSING_AWS_CDK_STACK_REST_API</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR_MESSAGE_MISSING_AWS_CONFIG</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> functionProps<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>FunctionProps<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lambdaVpcConfig
    <span class="token keyword">const</span> functionNamePrefix <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>stage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">const</span> _buildLambdaFunction <span class="token operator">=</span> <span class="token function">buildLambdaFunction</span><span class="token punctuation">(</span>
      Code<span class="token punctuation">.</span><span class="token function">fromAsset</span><span class="token punctuation">(</span>codeZipPath<span class="token punctuation">)</span><span class="token punctuation">,</span>
      codeFilename<span class="token punctuation">,</span>
      functionNamePrefix<span class="token punctuation">,</span>
      functionProps<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment">// ... build Lambdas</span>
    <span class="token keyword">const</span> getBooksLambda <span class="token operator">=</span> <span class="token function">_buildLambdaFunction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack<span class="token punctuation">,</span> <span class="token string">&apos;getBooks&apos;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configData<span class="token punctuation">)</span>
    <span class="token keyword">const</span> getBookLambda <span class="token operator">=</span> <span class="token function">_buildLambdaFunction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack<span class="token punctuation">,</span> <span class="token string">&apos;getBook&apos;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configData<span class="token punctuation">)</span>
    <span class="token keyword">const</span> createBookLambda <span class="token operator">=</span> <span class="token function">_buildLambdaFunction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack<span class="token punctuation">,</span> <span class="token string">&apos;createBook&apos;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configData<span class="token punctuation">)</span>
    <span class="token keyword">const</span> updateBookLambda <span class="token operator">=</span> <span class="token function">_buildLambdaFunction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack<span class="token punctuation">,</span> <span class="token string">&apos;updateBook&apos;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configData<span class="token punctuation">)</span>

    <span class="token comment">// ... attach Lambdas through resources and methods</span>
    <span class="token keyword">const</span> books <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack<span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token string">&apos;books&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;GET&apos;</span><span class="token punctuation">,</span> getBooksLambda<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack<span class="token punctuation">.</span>api<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
    <span class="token keyword">const</span> book <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack<span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token string">&apos;{id}&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;GET&apos;</span><span class="token punctuation">,</span> getBookLambda<span class="token punctuation">,</span> books<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack<span class="token punctuation">.</span><span class="token function">addMethod</span><span class="token punctuation">(</span><span class="token string">&apos;POST&apos;</span><span class="token punctuation">,</span> createBookLambda<span class="token punctuation">,</span> books<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apiGatewayStack<span class="token punctuation">.</span><span class="token function">addMethod</span><span class="token punctuation">(</span><span class="token string">&apos;PATCH&apos;</span><span class="token punctuation">,</span> updateBookLambda<span class="token punctuation">,</span> book<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
<h2 id="usage">Usage</h2>
<blockquote>
<p>Check out docs on <a href="https://github.com/Nona-Creative/nona-playground/blob/iso__base/docs/common/aws-profile.md" target="_blank">AWS Profile</a> usage before you run the commands below.</p>
</blockquote>
<h3 id="setup-project">Setup Project</h3>
<pre class="language-"><code class="lang-bash"><span class="token function">npm</span> run init
</code></pre>
<h3 id="envs">Envs</h3>
<h5 id="aws-secrets-manager">AWS Secrets Manager</h5>
<p>Create the following secret:</p>
<pre class="language-"><code class="lang-json">dbMasterPassword<span class="token operator">:</span> &lt;db password&gt;
</code></pre>
<p>Then copy the resulting ARN and use it to populate <code>SECRETS_ARN</code> in local env <code>packages/books-api-aws-cdk/.env.dev</code></p>
<h5 id="aws-paramstore">AWS Paramstore</h5>
<p>Add the following params to AWS Paramstore:</p>
<ul>
<li><code>nona-playground/books-api/dev/stage</code></li>
<li><code>nona-playground/books-api/dev/logLevel</code></li>
<li><code>nona-playground/books-api/dev/postgres/db</code></li>
<li><code>nona-playground/books-api/dev/postgres/host</code></li>
<li><code>nona-playground/books-api/dev/postgres/port</code></li>
<li><code>nona-playground/books-api/dev/postgres/user</code></li>
</ul>
<h3 id="deploy">Deploy</h3>
<pre class="language-"><code class="lang-bash"><span class="token function">npm</span> run books-api:aws:deploy dev
</code></pre>
<p>You can also remove (once you are done) with:</p>
<pre class="language-"><code class="lang-bash"><span class="token function">npm</span> run books-api:aws:destroy dev
</code></pre>
<h3 id="run-migrations">Run Migrations</h3>
<p>configure the following vars in <code>packages/books-api/.env.dev</code> in order to run migrations:</p>
<pre class="language-"><code>POSTGRES_HOST
POSTGRES_USER
POSTGRES_PASSWORD
POSTGRES_DB
POSTGRES_PORT
</code></pre><p>run migrations:</p>
<pre class="language-"><code class="lang-bash"><span class="token builtin class-name">cd</span> packages/books-api
<span class="token function">npm</span> run migrate:dev up
</code></pre>
<p>You can also now populate the <code>books</code> table with some example data.</p>
<h3 id="test">Test</h3>
<pre class="language-"><code class="lang-bash">http <span class="token operator">&lt;</span>URL<span class="token operator">&gt;</span>/books
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: NoNa Playground Showcase">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Plugins_Showcase.html" class="navigation navigation-next " aria-label="Next page: Plugins Showcase">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"REST API AWS Lambda RDS Postgres","level":"1.2","depth":1,"next":{"title":"Plugins Showcase","level":"1.2.1","depth":2,"path":"Plugins_Showcase.md","ref":"Plugins_Showcase.md","articles":[]},"previous":{"title":"NoNa Playground Showcase","level":"1.1","depth":1,"path":"README.md","ref":"README.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-lunr","-search","search-plus","mermaid-v8","terminal","prism","-highlight","collapsible-chapters","insert-logo","prism-themes","github-edit","intopic-toc"],"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"},"pluginsConfig":{"prism":{"css":["prism-themes/themes/prism-a11y-dark.css"],"lang":{"flow":"typescript"},"ignore":["mermaid","eval-js"]},"intopic-toc":{"isCollapsed":true,"isScrollspyActive":true,"label":"Contents","maxDepth":6,"mode":"nested","selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4, .markdown-section h5, .markdown-section h6","visible":true},"mermaid-v8":{},"collapsible-chapters":{},"fontsettings":{"family":"sans","size":2,"theme":"white"},"github-edit":{"repo":"neilrussell6/gitbook-playground","branch":"master"},"prism-themes":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"terminal":{"copyButtons":true,"fade":false,"style":"classic"},"theme-default":{"showLevel":false,"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"}},"insert-logo":{"style":"background: none;","url":"https://github.com/neilrussell6/gitbook-playground/blob/master/logo.png?raw=true"},"search-plus":{}},"copyright":"All Rights Reserved","theme":"default","baiduStatisticsCode":"","author":"Author Name","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{"homePage":"/"},"title":"Site Title","language":"en-za","authorHomepage":"http://www.example.com","gitbook":"*","description":"site description"},"file":{"path":"REST_API_AWS_Lambda_RDS_Postgres.md","mtime":"2020-10-31T13:17:56.140Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-11-01T13:27:01.240Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        

    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-mermaid-v8/book/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-terminal/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-insert-logo/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-github-edit/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/anchor.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/gumshoe.polyfills.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    

<script src="gitbook/gitbook-plugin-mermaid-v8/mermaid/mermaid.min.js"></script>

    </body>
</html>

